---
- name: Ensure bg root exists
  ansible.builtin.file:
    path: "{{ bg_root }}"
    state: directory
    mode: '0755'

- name: Copy bg stack files
  ansible.builtin.copy:
    src: "{{ bg_stack_src_dir }}/"
    dest: "{{ bg_root }}/"
    mode: '0644'

- name: Ensure ACTIVE file exists
  ansible.builtin.copy:
    dest: "{{ active_color_file }}"
    content: "blue\n"
    force: false

- name: Read active color
  ansible.builtin.slurp:
    src: "{{ active_color_file }}"
  register: active_raw

- name: Set active/inactive
  ansible.builtin.set_fact:
    active_color: "{{ (active_raw.content | b64decode).strip() }}"
    inactive_color: "{{ 'green' if ((active_raw.content | b64decode).strip() == 'blue') else 'blue' }}"

- name: Set ports
  ansible.builtin.set_fact:
    active_port: "{{ blue_port if active_color == 'blue' else green_port }}"
    inactive_port: "{{ green_port if active_color == 'blue' else blue_port }}"
    active_service: "{{ 'blue' if active_color == 'blue' else 'green' }}"
    inactive_service: "{{ 'green' if active_color == 'blue' else 'blue' }}"

# nginx.conf가 디렉터리로 만들어져 있으면 제거해서 파일로 렌더링합니다. / Remove nginx.conf directory so we can render a file.
- name: Check nginx.conf path type
  ansible.builtin.stat:
    path: "{{ bg_root }}/nginx.conf"
  register: nginx_conf_stat

- name: Remove nginx.conf directory if present
  ansible.builtin.file:
    path: "{{ bg_root }}/nginx.conf"
    state: absent
  when: nginx_conf_stat.stat.isdir | default(false)

# compose up 전에 nginx.conf를 파일로 렌더링합니다(nginx가 파일로 마운트). / Render nginx.conf before compose up (nginx mounts it as a file).
- name: Render nginx config for current active
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: "{{ bg_root }}/nginx.conf"
    mode: '0644'
  vars:
    active_backend_service: "{{ active_service }}"
  register: nginx_conf_initial

# 1) inactive 스택을 최신으로 올림
- name: Compose up inactive stack
  community.docker.docker_compose_v2:
    project_src: "{{ bg_root }}"
    profiles:
      - "{{ inactive_color }}"
    state: present

# 2) inactive 헬스체크
- name: Healthcheck inactive
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ inactive_port }}{{ bg_health_path }}"
    status_code: 200
  register: hc_inactive
  retries: 30
  delay: 2
  until: hc_inactive.status == 200

# 3) nginx 업스트림 스위치 (active_backend_port 템플릿 렌더)
- name: Render nginx config to point new active
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: "{{ bg_root }}/nginx.conf"
    mode: '0644'
  vars:
    active_backend_service: "{{ inactive_service }}"
  register: nginx_conf_switch

# 4) nginx 컨테이너를 재시작해서 바인드 마운트 파일 변경을 반영합니다. / Restart nginx to pick up bind-mounted file changes.
- name: Restart nginx container if config changed
  community.docker.docker_container:
    name: sample-bg-nginx
    state: started
    restart: true
  when: (nginx_conf_initial.changed | default(false)) or (nginx_conf_switch.changed | default(false))

# 5) ACTIVE 전환 기록
- name: Switch ACTIVE
  ansible.builtin.copy:
    dest: "{{ active_color_file }}"
    content: "{{ inactive_color }}\n"

# 6) 이전 active 스택은 down(선택)
- name: Compose down old active stack (optional)
  community.docker.docker_compose_v2:
    project_src: "{{ bg_root }}"
    profiles:
      - "{{ active_color }}"
    state: absent
  when: (bg_keep_old | default(false)) | bool == false
